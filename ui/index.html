<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Your Assistant</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap');

  :root {
    --bg:          #0d0f12;
    --surface:     #161a1f;
    --surface2:    #1e2329;
    --border:      rgba(255,255,255,0.07);
    --accent:      #3ecf8e;
    --accent-dim:  rgba(62,207,142,0.15);
    --accent-glow: rgba(62,207,142,0.35);
    --user-bubble: #1f6b47;
    --agent-bubble:#1e2329;
    --text:        #e8eaed;
    --text-dim:    #6b7280;
    --text-muted:  #4b5563;
    --status-ok:   #3ecf8e;
    --status-think:#f59e0b;
    --status-err:  #ef4444;
    --radius:      18px;
    --radius-sm:   10px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  html, body {
    height: 100%;
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    overflow: hidden;
  }

  /* â”€â”€ Layout â”€â”€ */
  .app {
    display: grid;
    grid-template-columns: 280px 1fr;
    height: 100vh;
  }

  /* â”€â”€ Sidebar â”€â”€ */
  .sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-header {
    padding: 24px 20px 16px;
    border-bottom: 1px solid var(--border);
  }

  .assistant-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), #2563eb);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    margin-bottom: 12px;
    box-shadow: 0 0 20px var(--accent-glow);
    flex-shrink: 0;
  }

  .assistant-name {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    letter-spacing: -0.01em;
  }

  .assistant-status {
    font-size: 12px;
    color: var(--status-ok);
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: 3px;
  }

  .status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--status-ok);
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50%       { opacity: 0.4; }
  }

  /* â”€â”€ User profile card in sidebar â”€â”€ */
  .user-card {
    margin: 12px;
    padding: 14px;
    background: var(--surface2);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
  }

  .user-card-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-bottom: 8px;
    font-weight: 500;
  }

  .user-fact {
    font-size: 12px;
    color: var(--text-dim);
    padding: 3px 0;
    display: flex;
    gap: 8px;
    align-items: flex-start;
    line-height: 1.4;
  }

  .user-fact-icon { flex-shrink: 0; margin-top: 1px; }

  /* â”€â”€ Proactive suggestions â”€â”€ */
  .proactive-section {
    margin: 0 12px 12px;
    flex: 1;
    overflow-y: auto;
  }

  .proactive-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-bottom: 8px;
    font-weight: 500;
    padding-top: 4px;
  }

  .proactive-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 11px 13px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    font-size: 12.5px;
    color: var(--text-dim);
    line-height: 1.45;
  }

  .proactive-card:hover {
    border-color: var(--accent);
    background: var(--accent-dim);
    color: var(--text);
  }

  .proactive-card-title {
    font-size: 11px;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  /* â”€â”€ Main chat area â”€â”€ */
  .chat {
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  /* â”€â”€ Chat header â”€â”€ */
  .chat-header {
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }

  .chat-header-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .header-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), #2563eb);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  .header-name {
    font-size: 15px;
    font-weight: 600;
    letter-spacing: -0.01em;
  }

  .header-sub {
    font-size: 12px;
    color: var(--text-dim);
    margin-top: 1px;
  }

  .header-actions {
    display: flex;
    gap: 8px;
  }

  .header-btn {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-dim);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    transition: background 0.15s, color 0.15s;
  }

  .header-btn:hover { background: var(--surface2); color: var(--text); }

  /* â”€â”€ Messages â”€â”€ */
  .messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px 24px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    scroll-behavior: smooth;
  }

  .messages::-webkit-scrollbar { width: 4px; }
  .messages::-webkit-scrollbar-track { background: transparent; }
  .messages::-webkit-scrollbar-thumb { background: var(--surface2); border-radius: 4px; }

  /* â”€â”€ Date separator â”€â”€ */
  .date-separator {
    text-align: center;
    font-size: 11px;
    color: var(--text-muted);
    padding: 12px 0 6px;
    letter-spacing: 0.04em;
  }

  /* â”€â”€ Message rows â”€â”€ */
  .msg-row {
    display: flex;
    align-items: flex-end;
    gap: 8px;
    margin-bottom: 2px;
  }

  .msg-row.user { flex-direction: row-reverse; }

  .msg-avatar-sm {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), #2563eb);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    flex-shrink: 0;
    margin-bottom: 2px;
  }

  .msg-avatar-sm.user-av {
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
  }

  /* Hide avatar for consecutive same-sender messages */
  .msg-row.consecutive .msg-avatar-sm { visibility: hidden; }

  .bubble-wrap {
    display: flex;
    flex-direction: column;
    max-width: 68%;
    gap: 2px;
  }

  .msg-row.user .bubble-wrap { align-items: flex-end; }

  .bubble {
    padding: 10px 14px;
    border-radius: var(--radius);
    font-size: 14px;
    line-height: 1.55;
    word-break: break-word;
    position: relative;
    transition: opacity 0.2s;
  }

  /* Bubble shape adjustments */
  .msg-row.agent .bubble { border-bottom-left-radius: 4px; background: var(--agent-bubble); border: 1px solid var(--border); }
  .msg-row.agent.consecutive .bubble { border-top-left-radius: 4px; }
  .msg-row.user  .bubble { border-bottom-right-radius: 4px; background: var(--user-bubble); color: #fff; }
  .msg-row.user.consecutive .bubble { border-top-right-radius: 4px; }

  /* â”€â”€ Status / stage message â”€â”€ */
  .bubble.streaming { opacity: 0.95; }
.stream-cursor {
  display: inline-block;
  animation: blink 0.8s infinite;
  color: #88aaff;
  margin-left: 2px;
}
@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}
.quick-ack-bubble {
  font-style: italic;
  font-size: 0.85em;
  opacity: 0.7;
  background: transparent !important;
  padding: 2px 8px !important;
}
.status-msg {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-muted);
    font-size: 12.5px;
    font-family: 'DM Mono', monospace;
    padding: 7px 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .stage-spinner {
    width: 12px;
    height: 12px;
    border: 2px solid var(--text-muted);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    flex-shrink: 0;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .stage-icon { flex-shrink: 0; }

  /* â”€â”€ Skill call bubble â”€â”€ */
  .bubble.skill-msg {
    background: rgba(37,99,235,0.12);
    border: 1px solid rgba(37,99,235,0.3);
    color: #93c5fd;
    font-size: 12px;
    font-family: 'DM Mono', monospace;
    padding: 7px 12px;
  }

  /* â”€â”€ Thinking bubble (DeepSeek R1) â”€â”€ */
  .bubble.think-msg {
    background: rgba(245,158,11,0.08);
    border: 1px solid rgba(245,158,11,0.2);
    color: #fcd34d;
    font-size: 12px;
    font-style: italic;
    padding: 7px 12px;
    max-height: 120px;
    overflow-y: auto;
  }

  /* â”€â”€ Timestamp â”€â”€ */
  .msg-time {
    font-size: 10.5px;
    color: var(--text-muted);
    padding: 0 4px;
    align-self: flex-end;
  }

  .msg-row.user .msg-time { text-align: right; }

  /* â”€â”€ Typing indicator â”€â”€ */
  .typing-indicator {
    display: none;
    align-items: flex-end;
    gap: 8px;
    padding: 4px 0;
  }

  .typing-indicator.visible { display: flex; }

  .typing-dots {
    background: var(--agent-bubble);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    border-bottom-left-radius: 4px;
    padding: 12px 16px;
    display: flex;
    gap: 5px;
    align-items: center;
  }

  .typing-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: var(--text-muted);
    animation: typingBounce 1.2s ease-in-out infinite;
  }

  .typing-dot:nth-child(2) { animation-delay: 0.15s; }
  .typing-dot:nth-child(3) { animation-delay: 0.3s; }

  @keyframes typingBounce {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
    30%            { transform: translateY(-6px); opacity: 1; }
  }

  /* â”€â”€ Proactive notification bubble â”€â”€ */
  .proactive-bubble {
    background: linear-gradient(135deg, rgba(62,207,142,0.1), rgba(37,99,235,0.1));
    border: 1px solid rgba(62,207,142,0.3);
    border-radius: var(--radius);
    border-bottom-left-radius: 4px;
    padding: 12px 16px;
    font-size: 13.5px;
    line-height: 1.55;
    max-width: 68%;
    color: var(--text);
  }

  .proactive-tag {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--accent);
    margin-bottom: 6px;
  }

  /* â”€â”€ Input area â”€â”€ */
  .input-area {
    padding: 16px 24px 20px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    flex-shrink: 0;
  }

  .input-wrap {
    display: flex;
    align-items: flex-end;
    gap: 10px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 8px 8px 8px 18px;
    transition: border-color 0.2s;
  }

  .input-wrap:focus-within { border-color: var(--accent); }

  #messageInput {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    line-height: 1.5;
    resize: none;
    max-height: 140px;
    overflow-y: auto;
    padding: 4px 0;
  }

  #messageInput::placeholder { color: var(--text-muted); }

  #messageInput::-webkit-scrollbar { width: 3px; }
  #messageInput::-webkit-scrollbar-thumb { background: var(--surface2); }

  .send-btn {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    border: none;
    background: var(--accent);
    color: #0d0f12;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
    font-size: 16px;
  }

  .send-btn:hover { transform: scale(1.05); box-shadow: 0 0 14px var(--accent-glow); }
  .send-btn:active { transform: scale(0.95); }
  .send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* â”€â”€ Markdown in bubbles â”€â”€ */
  .bubble p { margin: 0 0 8px; }
  .bubble p:last-child { margin-bottom: 0; }
  .bubble code {
    font-family: 'DM Mono', monospace;
    font-size: 12.5px;
    background: rgba(255,255,255,0.08);
    padding: 1px 5px;
    border-radius: 4px;
  }
  .bubble pre {
    background: rgba(0,0,0,0.35);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    overflow-x: auto;
    margin: 8px 0;
    font-size: 12.5px;
    font-family: 'DM Mono', monospace;
    line-height: 1.5;
  }
  .bubble pre code { background: none; padding: 0; }
  .bubble strong { font-weight: 600; color: var(--text); }
  .bubble em { color: #a5b4fc; }
  .bubble ul, .bubble ol { padding-left: 18px; margin: 6px 0; }
  .bubble li { margin: 3px 0; }
  .bubble a { color: var(--accent); text-decoration: none; }
  .bubble a:hover { text-decoration: underline; }
  .bubble h1, .bubble h2, .bubble h3 {
    font-weight: 600;
    margin: 10px 0 6px;
    letter-spacing: -0.01em;
  }

  /* â”€â”€ Scrollbar for sidebar â”€â”€ */
  .proactive-section::-webkit-scrollbar { width: 3px; }
  .proactive-section::-webkit-scrollbar-thumb { background: var(--surface2); }

  /* â”€â”€ Responsive â”€â”€ */
  @media (max-width: 700px) {
    .app { grid-template-columns: 1fr; }
    .sidebar { display: none; }
  }

  /* â”€â”€ Animations â”€â”€ */
  .msg-row { animation: msgIn 0.2s ease-out; }
  @keyframes msgIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .bubble.status-msg { animation: fadeIn 0.15s ease-out; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>
</head>
<body>

<div class="app">

  <!-- â”€â”€ Sidebar â”€â”€ -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="assistant-avatar">ðŸ¤–</div>
      <div class="assistant-name" id="assistantName">Assistant</div>
      <div class="assistant-status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Online Â· Local Â· Private</span>
      </div>
    </div>

    <div class="user-card" id="userCard">
      <div class="user-card-label">What I know about you</div>
      <div id="userFacts">
        <div class="user-fact"><span class="user-fact-icon">ðŸ’¬</span><span>Learning from our conversation...</span></div>
      </div>
    </div>

    <div class="proactive-section">
      <div class="proactive-label">Suggestions</div>
      <div id="proactiveCards"></div>
    </div>
  </aside>

  <!-- â”€â”€ Chat â”€â”€ -->
  <main class="chat">
    <div class="chat-header">
      <div class="chat-header-left">
        <div class="header-avatar">ðŸ¤–</div>
        <div>
          <div class="header-name" id="headerName">Your Assistant</div>
          <div class="header-sub" id="headerSub">Always private. Always local.</div>
        </div>
      </div>
      <div class="header-actions">
        <button class="header-btn" onclick="clearChat()" title="Clear chat">ðŸ—‘</button>
        <button class="header-btn" onclick="showProfile()" title="Your profile">ðŸ‘¤</button>
      </div>
    </div>

    <div class="messages" id="messages">
      <div class="date-separator">Today</div>
    </div>

    <!-- Typing indicator -->
    <div class="typing-indicator" id="typingIndicator">
      <div class="msg-avatar-sm">ðŸ¤–</div>
      <div class="typing-dots">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>

    <div class="input-area">
      <div class="input-wrap">
        <textarea
          id="messageInput"
          placeholder="Message your assistant..."
          rows="1"
          autocomplete="off"
          spellcheck="true"
        ></textarea>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
            <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
  </main>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const API = `${window.location.protocol}//${window.location.hostname}:8765`;
let isProcessing = false;
let lastSender = null;
let userProfile = {};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Markdown renderer (simple, no deps)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMarkdown(text) {
  if (!text) return '';
  return text
    // Code blocks
    .replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) =>
      `<pre><code class="lang-${lang}">${escHtml(code.trim())}</code></pre>`)
    // Inline code
    .replace(/`([^`]+)`/g, (_, c) => `<code>${escHtml(c)}</code>`)
    // Bold
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    // Italic
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    // Headers
    .replace(/^### (.+)$/gm, '<h3>$1</h3>')
    .replace(/^## (.+)$/gm,  '<h2>$1</h2>')
    .replace(/^# (.+)$/gm,   '<h1>$1</h1>')
    // Bullet lists
    .replace(/^\- (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>[\s\S]*?<\/li>)/g, '<ul>$1</ul>')
    // Numbered lists
    .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
    // Links
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
    // Paragraphs (double newlines)
    .replace(/\n\n+/g, '</p><p>')
    // Single newlines to <br>
    .replace(/\n/g, '<br>')
    // Wrap in p
    .replace(/^(?!<[hup])(.+)/, '<p>$1</p>');
}

function escHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Time helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function timeNow() {
  return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Message rendering
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendMessage(sender, content, type = 'normal', opts = {}) {
  if (!content && type === 'status') return null;
  const container = document.getElementById('messages');
  const isUser = sender === 'user';
  const consecutive = lastSender === sender && type === 'normal';

  const row = document.createElement('div');
  row.className = `msg-row ${isUser ? 'user' : 'agent'} ${consecutive ? 'consecutive' : ''}`;

  let bubbleClass = 'bubble';
  let bubbleContent = '';

  if (type === 'status') {
    bubbleClass += ' status-msg';
    bubbleContent = `<div class="stage-spinner"></div><span>${escHtml(content)}</span>`;
  } else if (type === 'status-done') {
    bubbleClass += ' status-msg';
    bubbleContent = `<span class="stage-icon">âœ“</span><span>${escHtml(content)}</span>`;
  } else if (type === 'skill') {
    bubbleClass += ' skill-msg';
    bubbleContent = `âš™ ${escHtml(content)}`;
  } else if (type === 'quick_ack') {
    bubbleClass += ' quick-ack-bubble';
    bubbleContent = escHtml(content);
  } else if (type === 'think') {
    bubbleClass += ' think-msg';
    bubbleContent = `ðŸ’­ ${escHtml(content.substring(0, 300))}${content.length > 300 ? '...' : ''}`;
  } else if (type === 'proactive') {
    // Special proactive layout
    const wrap = document.createElement('div');
    wrap.style.display = 'flex';
    wrap.style.alignItems = 'flex-end';
    wrap.style.gap = '8px';
    wrap.style.marginBottom = '4px';
    const av = document.createElement('div');
    av.className = 'msg-avatar-sm';
    av.textContent = 'ðŸ¤–';
    const pb = document.createElement('div');
    pb.className = 'proactive-bubble';
    pb.innerHTML = `<div class="proactive-tag">ðŸ’¡ Heads up</div>${renderMarkdown(content)}`;
    wrap.appendChild(av);
    wrap.appendChild(pb);
    container.appendChild(wrap);
    scrollToBottom();
    return wrap;
  } else {
    bubbleContent = renderMarkdown(content);
  }

  const avatarEl = document.createElement('div');
  avatarEl.className = `msg-avatar-sm ${isUser ? 'user-av' : ''}`;
  avatarEl.textContent = isUser ? 'ðŸ‘¤' : 'ðŸ¤–';

  const bubbleWrap = document.createElement('div');
  bubbleWrap.className = 'bubble-wrap';

  const bubbleEl = document.createElement('div');
  bubbleEl.className = bubbleClass;
  bubbleEl.innerHTML = bubbleContent;
  bubbleEl.dataset.msgId = opts.id || '';

  const timeEl = document.createElement('div');
  timeEl.className = 'msg-time';
  timeEl.textContent = timeNow();

  bubbleWrap.appendChild(bubbleEl);
  if (type === 'normal') bubbleWrap.appendChild(timeEl);

  if (isUser) {
    row.appendChild(bubbleWrap);
    row.appendChild(avatarEl);
  } else {
    row.appendChild(avatarEl);
    row.appendChild(bubbleWrap);
  }

  container.appendChild(row);

  if (type === 'normal') lastSender = sender;

  scrollToBottom();
  return bubbleEl;
}

function removeElement(el) {
  if (el && el.parentElement) el.parentElement.remove();
}

function scrollToBottom() {
  const c = document.getElementById('messages');
  c.scrollTop = c.scrollHeight;
}

function showTyping() {
  document.getElementById('typingIndicator').classList.add('visible');
  scrollToBottom();
}

function hideTyping() {
  document.getElementById('typingIndicator').classList.remove('visible');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Send message
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMessage() {
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  if (!text || isProcessing) return;

  input.value = '';
  input.style.height = 'auto';
  input.rows = 1;
  currentStageEl = null;
  streamingBubbleEl = null;
  streamingBubbleRow = null;
  streamingText = '';
  quickAckEl = null;
  isProcessing = true;
  currentStageEl = null;
  document.getElementById('sendBtn').disabled = true;

  appendMessage('user', text);

  // Stage bubble created by stream
  const s1 = null;

  // Connect to streaming status endpoint
  try {
    const resp = await fetch(`${API}/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text })
    });

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let stageEl = s1;
    let buffer = '';

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });

      const lines = buffer.split('\n');
      buffer = lines.pop();

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        try {
          const event = JSON.parse(line.slice(6));
          handleStreamEvent(event, stageEl);
          if (event.type === 'stage') stageEl = event._el || stageEl;
        } catch (e) {}
      }
    }
  } catch (err) {
    removeElement(s1);
    appendMessage('agent', `Connection error: ${err.message}. Is the agent running?`);
  }

  isProcessing = false;
  document.getElementById('sendBtn').disabled = false;
  hideTyping();
  loadProfile();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Stream event handler
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentStageEl = null;
let streamingBubbleEl = null;
let streamingBubbleRow = null;
let streamingText = '';
let quickAckEl = null;

function handleStreamEvent(event, stageEl) {
  switch (event.type) {

    case 'quick_ack':
      if (event.message) {
        quickAckEl = appendMessage('agent', event.message, 'quick_ack');
      }
      break;

    case 'token':
      if (!streamingBubbleEl) {
        if (quickAckEl) { removeElement(quickAckEl); quickAckEl = null; }
        if (currentStageEl) { removeElement(currentStageEl); currentStageEl = null; }
        const row = document.createElement('div');
        row.className = 'msg-row agent';
        const av = document.createElement('div');
        av.className = 'msg-avatar-sm';
        av.textContent = 'ðŸ¤–';
        const wrap = document.createElement('div');
        wrap.className = 'bubble-wrap';
        streamingBubbleEl = document.createElement('div');
        streamingBubbleEl.className = 'bubble streaming';
        wrap.appendChild(streamingBubbleEl);
        row.appendChild(av);
        row.appendChild(wrap);
        document.getElementById('messages').appendChild(row);
        streamingBubbleRow = row;
      }
      streamingText += event.text;
      streamingBubbleEl.innerHTML = renderMarkdown(streamingText) + '<span class="stream-cursor">â–‹</span>';
      scrollToBottom();
      break;

    case 'stage':
      if (currentStageEl) removeElement(currentStageEl);
      currentStageEl = appendMessage('agent', event.message, 'status');
      event._el = currentStageEl;
      break;

    case 'stage_done':
      if (currentStageEl) {
        // Convert spinner to checkmark
        currentStageEl.className = 'bubble status-msg';
        currentStageEl.innerHTML = `<span class="stage-icon">âœ“</span><span>${escHtml(event.message)}</span>`;
      }
      currentStageEl = null;
      break;

    case 'skill_call':
      appendMessage('agent', `${event.skill}(${JSON.stringify(event.args || {})})`, 'skill');
      break;

    case 'thinking':
      appendMessage('agent', event.text, 'think');
      break;

    case 'final':
      if (currentStageEl) { removeElement(currentStageEl); currentStageEl = null; }
      if (quickAckEl) { removeElement(quickAckEl); quickAckEl = null; }
      hideTyping();
      if (streamingBubbleRow && event.message) {
        streamingBubbleEl.classList.remove('streaming');
        streamingBubbleEl.innerHTML = renderMarkdown(event.message);
        const timeEl = document.createElement('div');
        timeEl.className = 'msg-time';
        timeEl.textContent = timeNow();
        streamingBubbleRow.querySelector('.bubble-wrap').appendChild(timeEl);
        scrollToBottom();
      } else if (event.message) {
        appendMessage('agent', event.message);
      }
      streamingBubbleEl = null;
      streamingBubbleRow = null;
      streamingText = '';
      break;

    case 'proactive':
      appendMessage('agent', event.message, 'proactive');
      break;

    case 'error':
      if (currentStageEl) removeElement(currentStageEl);
      currentStageEl = null;
      appendMessage('agent', `âš  ${event.message}`);
      break;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Profile & proactive cards
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadProfile() {
  try {
    const r = await fetch(`${API}/profile`);
    const data = await r.json();
    userProfile = data;
    renderProfile(data);
  } catch (e) {}
}

function renderProfile(data) {
  const facts = data.facts || [];
  const el = document.getElementById('userFacts');
  if (!facts.length) return;
  el.innerHTML = facts.slice(0, 6).map(f =>
    `<div class="user-fact"><span class="user-fact-icon">${f.icon || 'â€¢'}</span><span>${escHtml(f.text)}</span></div>`
  ).join('');

  // Update assistant name if personalised
  if (data.assistant_name) {
    document.getElementById('assistantName').textContent = data.assistant_name;
    document.getElementById('headerName').textContent = data.assistant_name;
  }
}

async function loadProactive() {
  try {
    const r = await fetch(`${API}/proactive`);
    const data = await r.json();
    const container = document.getElementById('proactiveCards');
    container.innerHTML = '';
    (data.suggestions || []).forEach(s => {
      const card = document.createElement('div');
      card.className = 'proactive-card';
      card.innerHTML = `<div class="proactive-card-title">${escHtml(s.category)}</div>${escHtml(s.text)}`;
      card.onclick = () => {
        document.getElementById('messageInput').value = s.action;
        document.getElementById('messageInput').focus();
      };
      container.appendChild(card);
    });
  } catch (e) {}
}

function showProfile() {
  loadProfile();
  alert('Profile panel coming soon â€” check sidebar for known facts.');
}

function clearChat() {
  if (!confirm('Clear conversation?')) return;
  document.getElementById('messages').innerHTML = '<div class="date-separator">Today</div>';
  lastSender = null;
  currentStageEl = null;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Auto-resize textarea
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('messageInput').addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 140) + 'px';
});

document.getElementById('messageInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    e.stopPropagation();
    sendMessage();
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Init
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  await loadProfile();
  await loadProactive();

  // Poll for proactive messages every 5 minutes
  setInterval(loadProactive, 5 * 60 * 1000);
  setInterval(checkProactiveMessages, 10 * 60 * 1000);
}

async function checkProactiveMessages() {
  try {
    const r = await fetch(`${API}/proactive/push`);
    const data = await r.json();
    if (data.message) {
      appendMessage('agent', data.message, 'proactive');
    }
  } catch (e) {}
}

init();
</script>
</body>
</html>
